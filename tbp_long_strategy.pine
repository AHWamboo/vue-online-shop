//@version=5
strategy("TBP Long Strategy", overlay=true, initial_capital=100, default_qty_type=strategy.percent_of_equity, default_qty_value=100, commission_type=strategy.commission.percent, commission_value=0.1)

// ============================================================================
// INSTRUKCJA UŻYCIA Z ALERTAMI TBP (Standard):
// ============================================================================
// OPCJA 1: TradingView Alert-to-Order (ZALECANE)
// 1. Dodaj wskaźnik TBP (Standard) na wykresie
// 2. Utwórz alert na TBP (Standard) z wiadomością: "TBP (Standard) Open Long"
// 3. W ustawieniach alertu włącz "Alert to Order" → "Buy Market"
// 4. Strategia automatycznie wykona zlecenie gdy otrzyma alert
//
// OPCJA 2: Integracja TBP w strategii
// 1. Jeśli masz kod TBP, możesz go zaimportować tutaj
// 2. Ustaw warunek 'tbpLongCondition' poniżej na podstawie logiki TBP
// 3. Strategia automatycznie otworzy long gdy warunek będzie spełniony
//
// OPCJA 3: Ręczne wyzwalanie
// 1. Użyj przycisku "Otwórz Long" w ustawieniach strategii do testów
// ============================================================================

// Parametry strategii
takeProfitPercent = input.float(1.0, title="Take Profit (%)", minval=0.1, step=0.1, group="Parametry TP/SL")
useStopLoss = input.bool(false, title="Użyj Stop Loss", group="Parametry TP/SL")
stopLossPercent = input.float(2.0, title="Stop Loss (%)", minval=0.1, step=0.1, group="Parametry TP/SL")

// Ręczne wyzwalanie (dla testów)
manualTrigger = input.bool(false, title="Otwórz Long (Ręcznie)", group="Ręczne sterowanie")

// Warunek TBP do otwarcia longa
// TODO: Zastąp poniższy warunek logiką z TBP (Standard), np.:
// tbpLongCondition = ta.crossover(tbp_signal, 0) // przykład
// Jeśli używasz Alert-to-Order, możesz zostawić to jako false
tbpLongCondition = input.bool(false, title="Warunek TBP Long (do integracji)", group="Integracja TBP")

// Alert condition dla debugowania
alertcondition(tbpLongCondition or manualTrigger, title="Long Signal", message="TBP (Standard) Open Long")

// Logika otwierania longa
if (manualTrigger or tbpLongCondition) and strategy.position_size == 0
    strategy.entry("Long", strategy.long, comment="Long Entry")

// Obliczanie poziomów take profit i stop loss
var float entryPrice = na
var float takeProfitPrice = na
var float stopLossPrice = na

// Ustawienie cen TP/SL przy otwarciu pozycji
if strategy.position_size > 0 and strategy.position_size[1] == 0
    entryPrice := strategy.opentrades.entry_price(strategy.opentrades - 1)
    takeProfitPrice := entryPrice * (1 + takeProfitPercent / 100)
    stopLossPrice := useStopLoss ? entryPrice * (1 - stopLossPercent / 100) : na

// Resetowanie zmiennych po zamknięciu pozycji
if strategy.position_size == 0 and strategy.position_size[1] > 0
    entryPrice := na
    takeProfitPrice := na
    stopLossPrice := na

// Zamknięcie pozycji - Take Profit i Stop Loss
if strategy.position_size > 0 and not na(entryPrice)
    if useStopLoss and not na(stopLossPrice)
        strategy.exit("TP/SL", "Long", limit=takeProfitPrice, stop=stopLossPrice, comment="TP/SL")
    else
        strategy.exit("TP", "Long", limit=takeProfitPrice, comment="Take Profit")

// Wizualizacja na wykresie
plot(strategy.position_size > 0 and not na(entryPrice) ? entryPrice : na, "Entry Price", color=color.blue, linewidth=2)
plot(strategy.position_size > 0 and not na(takeProfitPrice) ? takeProfitPrice : na, "Take Profit", color=color.green, linewidth=1, style=plot.style_line)
if useStopLoss
    plot(strategy.position_size > 0 and not na(stopLossPrice) ? stopLossPrice : na, "Stop Loss", color=color.red, linewidth=1, style=plot.style_line)

// Informacje o strategii
var table infoTable = table.new(position.top_right, 2, 4, bgcolor=color.white, border_width=1)
if barstate.islast
    table.cell(infoTable, 0, 0, "Kapitał początkowy", text_color=color.black)
    table.cell(infoTable, 1, 0, "$100", text_color=color.black)
    table.cell(infoTable, 0, 1, "Take Profit", text_color=color.black)
    table.cell(infoTable, 1, 1, str.tostring(takeProfitPercent) + "%", text_color=color.green)
    table.cell(infoTable, 0, 2, "Kapitał aktualny", text_color=color.black)
    table.cell(infoTable, 1, 2, "$" + str.tostring(math.round(strategy.equity, 2)), text_color=color.black)
    table.cell(infoTable, 0, 3, "Zysk/Strata", text_color=color.black)
    profitLoss = strategy.equity - 100
    table.cell(infoTable, 1, 3, "$" + str.tostring(math.round(profitLoss, 2)), text_color=profitLoss >= 0 ? color.green : color.red)
